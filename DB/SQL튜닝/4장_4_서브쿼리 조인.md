## 서브쿼리 변환이 필요한 이유

- 하나의 결과집합을 얻기위해 여러 가지 다른 형태의 SQL로 표현할 수 있는데 어떤 것을 선택하느냐에 따라 성능이 다를 수 있으므로 옵티마이저가 비용을 평가하고 실행계획을 생성하기전 사용자로부터 전달받은 SQL을 최적화에 유리한 형태로 변환
- 쿼리변환: 옵티마이저가 SQL을 분석해 의미적으로 동일(같은 결과 집합을 생성)하면서도 더 나은 성능이 기대되는 형태로 재작성하는 것
- 서브쿼리: 하나의 SQL문 안에 괄호로 묶은 별도의 쿼리블록. 쿼리에 내장된 또 다른 쿼리
    - 인라인 뷰: FROM절에 사용한 서브쿼리
    - 중첩된 서브쿼리: 결과집합을 한정하기 위해 WHERE절에 사용한 서브쿼리. 서브쿼리가 메인쿼리 컬럼을 참조하는 형태를 ‘상관관계 있는(Correlated) 서브쿼리’ 라 부름.
    - 스칼라 서브쿼리: 한 레코드당 정확히 하나의 값을 반환하는 서브쿼리. 주로 SELECT-LIST에서 사용하지만 몇가지 예외사항 제외하면 컬럼이 올 수 있는 대부분의 위치에 사용
- 서브쿼리를 참조하는 메인쿼리도 하나의 쿼리블록. 옵티마이저는 쿼리 블록 단위로 최적화 수행

## 서브쿼리와 조인

- 메인쿼리와 서브쿼리 : 부모-자식 관계(종속적, 계층적 관계)
    - 서브쿼리는 메인쿼리에 종속되므로 단독실행불가
    - 메인쿼리 건수만큼 값을 받아 반복적으로 필터링하는 방식으로 실행

### 필터 오퍼레이션

- 서브쿼리를 필터 방식으로 처리
- no_unnest 힌트 사용(서브쿼리 풀지말고 그대로 수행하라고 지시하는 힌트)
- 기본적으로 NL조인과 처리 루틴 같음. ⇒ 실행계획에 FILTER부분 NESTED LOOPS로 치환하고 처리 루틴 해석, 부분범위처리도 가능
- NL조인과 차이점
    - 메인쿼리의 한 로우가 서브쿼리의 한 로우와 조인에 성공하는 순간 진행을 멈추고, 메인쿼리의 다음 로우를 계속 처리 ⇒ 메인쿼리 결과집합이 서브쿼리 M쪽 집합 수준으로 확장되는 현상 막기위함
    - 캐싱기능(서브쿼리 입력값에 따른 반환 값을 캐싱하는 기능)
        - 반환값(TRUE/FALSE) 여부를 확인하면 서브쿼리 수행하지 않아도 되므로 성능에 도움
        - 쿼리단위로 캐싱. 쿼리 시작시 PGA 메모리 공간할당. 쿼리 종료시 공간 반환
    - 메인쿼리에 종속되므로 조인순서가 고정(항상 메인쿼리가 드라이빙 집합)
- 대게 실행계획 상에서 맨 마지막 단계에 처리

### 서브쿼리 Unnesting

- 메인과 서브쿼리 간 계층구조를 서로 같은 레벨(flat구조)로 만들어줌. ⇒ 서브쿼리 Flattening
- 명시적으로 unnest힌트 사용
- 일반조인처럼 다양한 최적화 기법 사용 가능
- 서브쿼리 Unnesting하는 이유
    - 서브쿼리를 드라이빙 집합으로 사용가능
    - 다양한 조인 메소드를 선택할 수 있고 조인순서를 정할 수 있음
    - 조인형태로 변환시 옵티마이저가 필터 오퍼레이션보다 더 좋은 실행경로 찾을 가능성 높아짐

### 서브쿼리 Pushing

- 서브쿼리 필터링을 가능한 앞 단계에서 처리하도록 강제하는 기능
- push_subq/no_push_subq 힌트로 제어
- Unnesting 되지 않은 서브쿼리에만 작동
- push_subq힌트는 항상 no_unnest힌트와 함께 기술해 사용
    - /*+ no_unnest push_subq */
- 서브쿼리 필터링을 먼저 처리하여 조인단계로 넘어가는 로우수를 줄여 성능을 향상시키기 위해 사용
- 서브쿼리 필터링을 가능한 나중에 처리하게 하려면 no_unnest와 no_push_subq를 같이 사용
    - /*+ no_unnest no_push_subq */

## 뷰(View)와 조인

- 뷰 쿼리를 변환하지 않으면 뷰 쿼리블록을 독립적으로 최적화
- 뷰 독립 실행: 전체 데이터를 읽음
- 뷰 머징: 조인에 성공한 전체 집합 GROUP BY. merge
- 푸시다운: 대상 데이터 읽어 조인 & GROUP BY. no_merge push_pred
    - 조인조건 Pushdown
        - 쿼리 변환 기능.
        - 메인 쿼리를 실행하면 조인 조건절 값을 건건이 뷰 안으로 밀어넣는 기능
        - 실행계획에 ‘VIEW PUSHED PREDICATE’ 오퍼레이션으로 확인
        - push_pred 힌트 no_merge와 함께 사용

## 스칼라 서브쿼리 조인

- 특징
    - 메인쿼리 레코드마다 정확히 하나의 값만 반환.
    - 메인쿼리 건수만큼 테이블 반복해서 읽지만 재귀적으로 실행하는 구조는 아님.
    - 컨텍스트 스위칭 없이 메인/서브 쿼리 하나처럼 실행
    - Outer 조인처럼 하나의 문장으로 이해하고 NL조인방식으로 실행. 조인에 실패하는 레코드는 NULL값 출력.
- 캐싱효과
    - 조인 횟수를 최소화하기위해 입력 값과 출력 값을 내부캐시에 저장.
    - 캐시에서 찾지 못할 때만 조인 수행. 결과는 캐시에 저장
    - 입력값: 그 안에서 참조하는 메인쿼리의 컬럼 값
    - 필터 서브쿼리 캐싱과 같은 기능
    - SELECT-LIST에 사용한 함수는 메인쿼리 결과건수만큼 반복수행 ⇒ 스칼라 서브쿼리 덧씌우면 호출횟수 최소화
- 캐싱 부작용
    - 캐시 공간 부족.
    - 입력 값의 종료가 소수여서 해시 충돌 가능성 작을때 효과
    - 메인쿼리 집합이 매우 작은 경우 재사용성이 낮아 효과 떨어짐(서브쿼리 캐싱은 쿼리단위이므로 메인쿼리 집합 클수록 재사용성이 높음)
- 두개 이상의 값 반환X
- 병렬쿼리에서 될 수 있으면 스칼라 서브쿼리 사용X
