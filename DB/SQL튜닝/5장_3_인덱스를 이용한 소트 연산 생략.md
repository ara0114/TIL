# 인덱스를 이용한 소트 연산 생략

- 인덱스는 항상 키 컬럼 순으로 정렬된 상태 유지
    - Order by 나 Group by절이 있어도 소트 연산 생략할 수 있음
- Top N 쿼리 특성 결합 시 OLTP시스템에서 대량 데이터 조회 시 매우 빠른 응답 속도 낼 수 있음. 특정 조건을 만족하는 최소/최대값도 빨리 찾을 수 있어 이력 데이터 조회 시 매우 유용

## Sort Order By 생략

- 선두 컬럼을 where조건절의 컬럼 + order by절의 컬럼 순으로 구성하면 소트 연산 생략 가능
    - 전체 데이터 읽지 않고 바로 결과집합 출력 시작가능
    - 부분범위 처리 가능한 상태
    - 소트대상 레코드가 무수히 많은 상황에서 극적인 성능 개선 효과

## Top N 쿼리

- Top N쿼리: 전체 결과 집합 중 상위N개 레코드만 선택하는 쿼리
    - 오라클의 경우 인라인뷰로 감싸 rownum 이용
    - 중간 집합을 만들어 상위n개 레코드를 취하는 형태
- Top N Stopkey 알고리즘(p.354 실행계획참고)
    - **COUNT(STOPKEY)** 로 실행계획에 나타남
    - 조건절에 부합하는 레코드 아무리 많아도 rownum으로 지정한 건수 만큼 결과 레코드를 얻으면 거기서 바로 멈춤
    - 선두컬럼을 where조건절 컬럼 + order by절의 컬럼 순으로 구성 ⇒ 소트연산 생략
- 페이징처리
    - 3-Tier 환경에서 대량의 결과집합을 조회할때 활용(표준패턴 p.355참조)
    - 부분범위 처리 가능한 SQL작성해야함
        - 인덱스 사용가능한 조건절 구성
        - 조인은 NL조인 위주로 처리
        - Order by절이 있어도 소트 연산 생략할 수 있도록 인덱스 구성
    - **COUNT(STOPKEY) → NO SORT + STOPKEY** 로 실행계획에 나타남
- 페이징처리 ANTI패턴
    - ROWNUM조건절을 제거하고 표현(p.357패턴 참조)
    - ROWNUM은 Top N Stopkey 를 작동시키는 키 이므로 제거하면 실행계획 변경 ⇒ **COUNT → NO SORT + NO STOP**
    - 소트연산은 생략가능하지만 Stopkey가 작동하지 않아 전체범위를 처리

## 최소값/최대값 처리

- 인덱스는 정렬돼 있으므로 전체 데이터를 읽지않고 최소 또는 최대값을 쉽게 찾을 수 있음.
    - 인덱스 맨 왼쪽으로 내려가 첫번째 읽는 값이 최소값, 맨 오른쪽으로 내려가 첫번째 읽는 값이 최대값
- 인덱스를 이용해 최소/최대값 구하기 위한 조건
    - 조건절 컬럼과 MIN/MAX 함수 인자 컬럼이 모두 인덱스에 포함되어 있어야함(테이블 액세스가 발생하지 않아야 함)
    - First Row Stopkey알고리즘
        - 실행계획에 FIRST ROW
        - 조건을 만족하는 레코드 하나 찾았을 때 바로 멈춘다는 의미
- Top N쿼리 이용해 최소/최대값 구하기
    - ROWNUM ≤1 조건을 이용해 TOP 1 레코드를 찾음
    - Top N Stopkey알고리즘은 모든 컬럼이 인덱스에 포함되지 않아도 잘 작동함
    - 인라인 뷰를 사용하여 복잡하지만 성능 측면에서는 MIN/MAX쿼리보다 나음

## 이력 조회

- 가장 단순한 이력 조회
    - First Row Stopkey 또는 Top N Stopkey 알고리즘이 작동할 수 있게 인덱스를 설계하고 SQL구현하는 것 매우 중요
- 점점 복잡해지는 이력 조회
    - 인덱스를 가공해 First Row Stopkey 알고리즘이 작동하지 않음
        - 이력이 많을 경우 문제
        - 쿼리를 변경하여 알고리즘이 작동할 수 있게 변경(p.369)
- INDEX_DESC 힌트 활용
    - 인덱스를 역순으로 읽고 첫번째 레코드에서 바로 멈추도록 ROWNUM ≤1사용
    - 인덱스 구성이 완벽해야 쿼리가 잘 작동
    - 전통적으로 사용해온 방식
- 상황에 따라 달라져야 하는 이력 조회 패턴
    - 전체 또는 상당히 많은 장비의 이력을 조회할때는 인덱스를 이용한 Stopkey기능 작동여부가 튜닝의 핵심요소가 아님
    - 인덱스 활용패턴도 랜덤 I/O 발생량만큼 성능도 비례해 느려지므로 대량데이터 조회할때 좋은 솔루션이 아님
    - 전체 장비의 이력 조회시 윈도우 함수(Full Scan + 해시조인)나 KEEP절 활용
    - 업무 특성에 따라 선분이력 모델 고려

## Sort Group By 생략

- 선두컬럼 인덱스 활용해 Sort Group By 연산 생략가능
- 실행계획에 **SORT GROUP BY NOSORT**로 표시
