# SQL 파싱과 최적화

## SQL: Structured Query Language

- 구조적(structured), 집합적(set-based), 선언적(declarative) 질의 언어

*cf*. 오라클 PL/SQL, SQL Server T-SQL - 절차적(procedural) 프로그래밍 기능을 구현할 수 있는 확장언어

- 원하는 결과집합을 구조적, 집합적으로 선언하지만 결과집합을 만드는 과정은 절차적 => 프로시저 필요
- SQL 옵티마이저 : 프로시저를 만들어 내는 DBMS 내부엔진

## SQL 최적화

- DBMS 내부에서 프로시저를 작성하고 컴파일해서 실행가능한 상태로 만드는 전 과정

### 최적화 과정

1. SQL파싱

   - 파싱트리 생성: SQL문을 이루는 개별 구성요소를 분석해 파싱 트리 생성


   - Syntax 체크: 문법적 오류 확인(ex. 사용할 수 없는 키워드의 사용, 순서, 누락된 키워드 확인 등)


   - Semantic 체크: 의미상 오류 확인(ex. 존재하지 않는 테이블 또는 컬럼의 사용, 사용한 오브젝트의 권한 유무 확인 등)

2. SQL최적화

   - 옵티마이저가 역할을 맡아 SQL최적화 진행.

   - SQL 옵티마이저: 미리 수집한 시스템 및 오브젝트 통계정보를 바탕으로 다양한 실행경로를 생성해 비교한 후 가장 효율적인 하나를 선택. 데이터베이스 성능을 결정하는 가장 핵심적인 엔진

3. 로우소스 생성

   - 로우소스 생성기(Row-Source Generator)가 역할을 맡아 진행

   - SQL 옵티마이저가 선택한 실행경로를 실제 실행가능한 코드 또는 프로시저 형태로 포맷팅하는 단계

## SQL 옵티마이저

- 사용자가 원하는 작업을 가장 효율적으로 수행할 수 있는 최적의 데이터 액세스 경로를 선택해주는 DBMS의 핵심엔진
- 옵티마이저의 최적화 단계
  - 사용자로부터 전달받은 쿼리를 수행하는데 후보군이 될만한 실행계획들을 찾아냄
  - 데이터 딕셔너리(Data Dictionary)에 미리 수집해 둔 오브젝트 통계 및 시스템 통계정보를 이용해 각 실행계획의 예상비용 산정
  - 최저 비용을 나타내는 실행계획 선택

- 별도 프로세스가 아닌 서버 프로세스가 가진 기능

## 실행계획과 비용

### 실행계획(Execution Plan)

- SQL 옵티마이저가 생성한 처리절차를 사용자가 확인할 수 있게 트리구조로 표현한 것.
- SQL 실행경로 미리보기 기능
  - 작성한 SQL이 테이블을 스캔하는지 인덱스를 스캔하는지, 어떤 인덱스로 스캔하는지 등
  - 실행경로 변경 가능

### 비용(Cost)

- 쿼리를 수행하는 동안 발생할 것으로 예상하는 I/O횟수 또는 예상 소요시간을 표현한 값
- 실행경로를 선택하기 위해 옵티마이저가 여러 통계정보를 활용해서 계산해 낸 값
- 예상치로 실측치가 아니기 때문에 실제 수행시 발생하는 I/O 또는 시간과 많은 차이가 남

## 옵티마이저 힌트

- 통계정보에 담을 수 없는 데이터 또는 업무특성을 활용해 개발자가 직접 더 효율적인 액세스 경로를 찾아낼 수도 있음

  => 옵티마이저 힌트를 이용해 데이터 액세스 경로를 바꿀수 있음

- 주석기호에 `+`를 붙이면 됌

  ```sql
  SELECT /*+ INDEX(테이블명 PK명) */
  	컬럼명1, 컬럼명2, 컬럼명3,..
  FROM 테이블명
  WHERE 조건
  ```

- 주의사항

  - 힌트 안에 인자를 나열시 콤마 사용이 가능하지만, 힌트와 힌트사이에 사용하면 안됌
  - 테이블 지정 시 스키마명까지 명시하면 안됌
  - FROM절 테이블명에 ALIAS를 지정했다면 힌트에도 반드시 ALIAS 사용해야함