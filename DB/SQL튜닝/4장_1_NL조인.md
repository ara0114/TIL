## 기본 메커니즘

- 인덱스를 이용한 조인 방식
- Nested Loop와 같은 수행구조 사용
- 일반적으로 Outer 와 Inner양쪽 테이블 모두 인덱스 이용
    - Outer쪽 사이즈가 크지 않으면 인덱스 이용하지 않을 수 있음.
    - Inner쪽 테이블은 인덱스 사용해야함. 인덱스 이용하지 않을경우 Outer루프에서 읽은 건수만큼 Table Full Scan 반복함

## NL 조인 실행계획 제어

- 실행계획에서 NESTED LOOPS 표기된 부분 확인할 수 있음
- NL조인 제어시 use_nl 힌트 사용
    - /*+ use_nl(A,B,C,D) */
    - /*+ ordered use_nl(B) use_nl(C) use_hash(D)  */ : driving 또는 outer table기준으로 inner테이블과 NL방식으로 조인
    - /*+ leading(C,AD,B) use_nl(A) use_nl(D) use_hash(B) */ : ordered대신 leading사용하여 순서를 제어할 수 있음.

## NL 조인 수행 과정 분석

- 각 단계를 모두 완료하고 다음 단계로 넘어가는 것이 아니라 한 레코드씩 순차적으로 진행.

## NL 조인 튜닝 포인트

- 아주 많은 랜덤액세스 발생하고 , 필터링되는 비율이 높을때 : 인덱스에 컬럼 추가
- 인덱스 탐색횟수(조인 액세스 횟수)가 많을수록 성능 느려짐. 조인 액세스 횟수는 Outer테이블을 읽고 필터링한 결과 건수에 의해 결정.
- 맨 처음 액세스하는 인덱스에서 얻은 결과 건수에 의해 전체 일량이 좌우됌. 첫 인덱스를 스캔하며 추출한 레코드가 많다면 후에 테이블 랜덤 액세스, 인덱스 탐색하는 횟수가 전반적으로 많아짐

### 올바른 조인 메소드 선택

- OLTP 시스템에서 튜닝 시 일차적으로 NL조인부터 고려
- 성능이 느리다면 각 단계의 수행 일량을 분석해 과도한 랜덤액세스가 발생하는 지점을 우선 파악
    - 조인 순서를 변경해 랜덤 액세스 줄일 수 있는지, 더 효과적인 인덱스가 있는지 등을 검토
    - 필요하다면 인덱스 추가 또는 구성 변경도 고려
- 여러 방안 검토 후, NL조인으로 결코 좋은 성능을 내기 어렵다 판단될때 소트 머지 조인이나 해시 조인 검토

## NL 조인 특징 요약

- 랜덤 액세스 위주의 조인방식
    - 레코드 하나를 읽으려 블록을 통째로 읽으므로 비효율 존재할 수 있음. ⇒ 대량 데이터 조인시 NL조인이 불리한 이유
- 조인을 한 레코드씩 순차적으로 진행
    - 부분 범위 처리가 가능할경우 큰 테이블을 조인하더라도 매우 빠른 응답 속도를 낼 수 있음.
    - 먼저 액세스 되는 테이블 처리 범위에 의해 전체 일량이 결정됨
- 다른 조인방식에 비해 인덱스 구성 전략이 특히 중요함.
    - 조인 컬럼에 대한 인덱스가 존재하는지. 있다면 컬럼이 어떻게 구성 되었는지에 따라 조인 효율이 크게 달라짐
- 위의 여러 특징 종합할때 소량데이터 주로 처리하거나  부분범위처리가 가능한 OLTP시스템에 적합한 조인 방식이라 할 수 있음.

## NL 조인 확장 메커니즘

- NL조인 성능을 높이기 위해 테이블 Prefetch, 배치I/O기능 도입
    - 읽는 블록마다 건건이 I/O Call을 발생시키는 비효율을 줄이기 위해 고안
- 테이블 Prefetch: 인덱스를 이용해 테이블을 액세스하다가 디스크I/O가 필요해지면 이어서 곧 읽게 될 블로갂지 미리 읽어 버퍼캐시에 적재하는 기능
    - nlj_prefetch, no_nlj_prefetch 힌트를 이용해 실행계획이 나오게 할 수도 있고 안나오게 할 수도 있음.
- 배치I/O: 디스크 I/O Call을 미뤘다가 읽을 블록이 일정량 쌓이면 한꺼번에 처리하는 기능
    - nlj_batching, no_nlj_batching 힌트를 이용해 실행계획이 나오게 할 수도 있고 안나오게 할 수도 있음.
- Inner쪽 테이블블록을 모두 버퍼캐시에서 읽으면 어떤 방식으로 수행하든 성능에 차이가 없고 데이터 출력순서도 같음
- 일부를 디스크에서 읽게되면 성능에 차이가 있을 수 있고, 배치I/O실행계획이 나타날때는 결과집합의 정렬순서도 다를 수 있음.(Inner쪽 테이블에 작동하는 결과집합의 정렬순서보장x)
    - 결과 집합이 항상 일정한 순서로 출력되기를 원한다면 배치I/O기능이 작동하지 못하도록 no_nlj_batching힌트 추가하거나 맨 바깥쪽 ORDER BY 절에 정렬기준 명시
    - 바깥쪽 메인쿼리에 ORDER BY를 추가했어도 안쪽ORDER BY를 함부로 제거하면 안됌. Top N쿼리를 구현하기 위한것
