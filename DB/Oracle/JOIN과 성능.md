# 내부적인 JOIN 처리방식

## NL JOIN(Nested Loops JOIN)

- 중첩된 반복문 형태로 데이터를 연결하는 방식
- 가장 오래된 조인 방식, RDBMS에서 가장 많이 사용하는 내부적인 조인 처리 방식
- 선행 집합(테이블)과 후행 집합(테이블) 정의가 매우 중요함
- 가장 적은 비용으로 빠르게 조인 결과를 얻을 수 있음. 많은 양의 데이터를 조인X
- 데이터 건 수만큼 테이블 반복  접근
- OLTP시스템에서 자주 사용되는 핵심 SQL 처리

## MERGE JOIN(Sort Merge 또는 Sort JOIN)

- 두 데이터 집합을 연결 조건 값으로 정렬한 후 조인을 처리하는 방식
- 조인할 데이터 먼저 정렬해야 하고 정렬된 데이터 차례로 읽어가며 조인 수행
- 동일한 테이블 반복 접근X
- 소트(정렬) 작업을 얼마나 줄이는 지가 성능 향상 포인트

## HASH JOIN

- 해시 함수를 이용한 처리 방식
- 대용량 데이터를 조인할 때 적합. 대량의 데이터 조회해서 분석 수행해야 할 때 유용.
조인 조건 컬럼에 적절한 인덱스 만들기 어려울 때 활용
- 고비용의 해시함수와 메모리인 해시영역 사용하는 비용 추가
- 후행집합 반복 접근X. 정렬작업X.
- 조인 성능 문제 대부분 해결. But 더 많은 CPU와 메모리 자원 사용하므로 무조건 해결방법으로 사용X

## 성능

- NL조인에서 고려해야할 부분
    - 후행 집합의 조인 조건 컬럼에는 인덱스 필수
    - 후행 집합에 사용된 조인 조건과 WHERE 조건 컬럼에 복합 인덱스 고려
    - 조인 횟수 줄이기 ⇒ 후행 집합의 접근 횟수 줄이기 ⇒ 선행 집합의 결과 건수 줄이기
        - 선행 집합 변경 후 Buffers가 줄어 성능 개선되었는지 실행계획 확인
        - 항상 선행 집합 크기가 작은 쪽을 선택해야 하는 것은 아님
        (ex. 인덱스로 읽어야 할 데이터가 너무 많은 경우)
- Merge조인에서 고려해야할 부분
    - 조인대상을 미리 모아 놓고 한 번에 조인 처리하므로 대량의 데이터 조인 처리시 효율적
    - 조인에 참여하는 데이터를 각각 조회해 조인을 처리
    ⇒ 조인에 참여하는 테이블별로 대상을 줄일 수 있는 조건에 인덱스 생성
- HASH조인에서 고려해야할 부분
    - 대용량의 데이터 조인 시 필수.(머지 조인처럼 정렬부담X)
        - 머지 조인에서 정렬을 인덱스로 제거할 수 있으면 머지 조인이 성능 더 좋을 수 있음.
    - 선행 집합 선택 매우 중요.
    - 선행 집합은 Build-Input으로 처리, 후행 집합은 Probe-Input으로 처리
        - Build-Input: 조인할 대상에 해시 함수를 적용해 조인 준비를 하는 과정
        - Probe-Input: 후행 집합에 해시 함수를 적용해 빌드 입력과 비교해 조인을 처리하는 과정
    - Build-Input의 데이터가 적을수록 성능에 유리.
        - 메모리의 해시영역에 모두 위치해야만 최고의 성능을 낼 수 있음
        ⇒ 데이터가 많아 해시영역에 올릴 수 없으면 Temporary Space사용하게 되므로 성능 저하
- 쿼리변형(Query Transformation)
    - 옵티마이저가 자동으로 SQL을 변형하는 기능
    - 필요에 따라 직접 쿼리 변형을 할 필요가 있음. ⇒ 직접 조건 추가 또는 SQL 변경
