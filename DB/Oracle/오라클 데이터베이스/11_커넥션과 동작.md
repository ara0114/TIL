## 오라클 커넥션

클라이언트 애플리케이션

- 오라클에 SQL을 실행하고 그 결과를 회신받는 애플리케이션
- 오라클의 일부가 아닌, 오라클에게 처리를 요청하는 외부에 존재하는 프로세스
- 대표적으로 SQL*Plus가 있음.

서버 프로세스

- SQL*Plus 등의 클라이언트 애플리케이션에서 실행된 SQL을 받아 검색/변경 등과 같은 각종 처리를 수행하는 프로세스
- 클라이언트 애플리케이션이 접속되어있을때만 기동.
- 인스턴스가 기동된 상태라 해도 항상 실행중인 것은 아님
- V$PROCESS뷰로 서버 프로세스나 백그라운드 프로세스 정보 확인할 수 있음.

세션

- 오라클에 접속한 상태를 세션이 수립됐다 함
- 서버 프로세스와 클라이언트 애플리케이션 사이의 세션: 접속요청을 전달받은 시점에 수립.
- 전용 서버 접속: 오라클의 기본 접속 형태. 한개의 세션마다 한개의 서버 프로세스 기동. 한 세션으로 여러번 요청/응답 주고 받을 수 있음
한 클라이언트 애플리케이션에서 수행한 요청은 세션을 통해 접속된 서버 프로세스 한개가 모두 처리함. 세션 종료시 서버 프로세스 함께 종료
- V$SESSION 뷰에서 확인할 수 있음.

소켓

- 오라클의 네트워크 통신수단
- 네트워크 안에 여러개 존재
- 송신측 주소(addresss)와 수신측 포트(port) 번호의 조합으로 식별

리스너(listener)

- 클라이언트 어플리케이션에서 네트워크를 통해 송신된 인스턴스로의 접속 요청을 접수하는 프로세스
- 서버 프로세스에게 요청을 넘기고 이후 처리를 서버 프로세스가 수행하도록 전달함
- 오라클에서 수신을 기다리는 프로세서
- 리스너로 커넥션 하는 프로세스는 업무 어플리케이션의 프로세스
- 세션이 수립된 후 해당 처리에 관여하지 않음.
- 하나의 리스너에는 하나의 리스너 로그 존재함.
- 원격접속: 네트워크를 통해 인스턴스에 접속할때 리스너를 기동하여 이를 통해 접속하는 형태.
    - 클라이언트/서버 접속이라 부르기도 함.
    - Oracle Net Services구성해야함.
    - 반드시 리스너 기동되어있어야함
- 로컬접속: 인스턴스가 기동되는 장비(데이터베이스 서버) 안에서 데이터베이스에 접속할때 리스너를 통하지않고 인스턴스에 접속하는 형태.
    - ORACLE_SID를 이용한 통신방식. 클라이언트 애플리케이션 실행전에 접속할 인스턴스명 설정해야함.
    - 리스너 기동 필요X
    - 사용하는 경우
        - 데이터베이스 기동/정지 등 관리작업 수행할때
        - Stand-alone환경
        - 단일 데이터베이스의 배치처리

### **동작과정**

1. `lsnrctl start` 명령으로 리스너 기동
    1. DB서버의 리스너가 listener.ora에서 설정 읽음
    2. 보통 오라클 리스너의 포트번호는 1521
    3. The command completed successfully 메시지 나오면 성공
2. 애플리케이션에서의 커넥션
    1. 업무 애플리케이션 안에서 커넥션 명령실행 되거나 `connect` 명령 실행하면 수행
    2. 오라클 클라이언트는 tnsnames.ora 의 커넥션 디스크립터 정보를 사용해 리스너와의 사이에 소켓 생성 및 통신 요청
3. 서버 프로세스 생성
    1. OS상에서 프로세스 생성
    2. 서버 프로세스가 공유메모리(SGA) 사용할 수 있도록 해야하며, 서버 프로세스용 메모리(PGA)도 확보해야함 + 데이터베이스 내부 처리
    3. 서버 프로세스 생성 끝나면 리스너가 소켓을 서버 프로세스로 인계
    - 서버 프로세스 생성은 무거운 작업이므로 가능하면 줄이는게 좋음.
    4. 서버 프로세스와 오라클 클라이언트 직접 송수신(리스너는 자유)

### 프로세스의 정지/리스너의 상태 확인

- 서버 프로세스 종료방법: 애플리케이션 접속 종료 처리 `close` 나 `disconnect`
- 리스너 정지: `lsnrctl stop`
- 리스너 상태확인: `lsnrctl status`
- 접속 강제 중지
    - `alter system kill session 'sid, serial#' immediate`;
    어쩔 수 없다면 alter system kill session을 사용해 세션(클라이언트와 오라클간의 커넥션)을 끊는다.
    - DCD(Dead Connection detection) 기능을 설정하여 커넥션 끊어진 사실을 자동으로 빠르게 검출
    : $ORACLE_HOME/network/admin/sqlnet.ora 설정파일의 SQLNET.EXPIRE_TIME 설정

### 성능개선

- **커넥션 풀** : 서버 프로세스 몇개를 풀로 만들어 두고 여러 애플리케이션이 자신이 쓰고 싶을 때만 풀에서 하나씩 꺼내 사용
⇒ 커넥션 횟수가 줄어 성능 좋아짐. 커넥션 수가 줄어 서버 프로세스가 사용하는 메모리 적어짐

### Oracle Net Services

- 설정파일

| 파일명 | 설명 | 위치 |
| --- | --- | --- |
| listener.ora | 리스너의 구성정보를 기재해두는 설정파일 | 데이터베이스 서버 |
| tnsnames.ora | 리스너아 오라클에 관련된 접속정보를 기재해두는 설정파일 | 클라이언트 장비, 데이터베이스 서버 |
| sqlnet.ora | Oracle Net에 관련된 각종 파라미터를 기재해두는 설정파일 | 데이터베이스 서버, 클라이언트 장비 |
- listener.ora
    - 구성정보
        - 리스너가 리스닝하기위한 프로토콜 주소: 리스너의 네트워크 주소. 서버 호스트명과 TCP포트번호
        - 리스너가 접속을 중계할 인스턴스 정보: 전역 데이터베이스 이름과 ORACLE_SID지정. 선택사항
- tnsnames.ora
    - 구성정보
        - net service명
        - connection descriptor(oracle net의 접속 정보)
            - 리스너 프로토콜주소
            - 접속할 인스턴스 정보
    - 이름에서 주소정보를 가져오는 name resolution방식
- sqlnet.ora
    - 원격으로 접속할때 여러가지 설정을 추가하는 옵션의 설정파일
    - 유닉스/리눅스 버전 오라클 에서는 설정 필요 X.
    - 윈도우 버전 오라클에는 SQLNET.AUTHENTICATION_SERVICES=NTS 설정 필요(기본)
    - 파라미터
        - NAMES.DEFAULT_DOMAIN: 도메인명 지정. 넷서비스명에 자동 추가됌
        - NAMES.DIRECTORY_PATH: name resolution방식에서 사용하는 naming method순서 지정.
        - SQLNET.AUTHENTICATION_SERVICES: 한개 이상의 인증 서비스를 사용할 수 있도록 함.
