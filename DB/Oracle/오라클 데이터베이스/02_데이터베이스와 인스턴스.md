# 데이터베이스와 인스턴스

## 데이터베이스 Instance관리

- 오라클 구축: 오라클 소프트웨어설치 → 설치한 오라클 소프트웨어에 포함된 DBCA(DB Configuration Assistant)사용해 DB와 인스턴스 생성
    - DB생성시 global database name과 SID지정해야함.
        - global database name: <DB_NAME>.<DB_DOMAIN> 형태로 설정. DB_DOMAIN지정되지 않을 경우 DB_NAME과 같은 값으로 설정
        - SID: System Identifier. 인스턴스 식별자. 일반적으로 DB_NAME과 같은 값으로 설정. 한 서버에 여러개 인스턴스 사용하고자 할때는 인스턴스마다 다른 SID지정

### 데이터베이스와 인스턴스

- 데이터베이스: 한개 이상의 컨트롤 파일 + 한개 이상의 데이터 파일 + 두개 이상의 REDO로그 파일
    - **Control File**: 제어정보 저장. 한개만 있어도 운영에는 문제 없지만 중요 정보 이므로 *다중화*할 필요 있음.
        - 인스턴스 동작에 반드시 필요한 바이너리 파일.
        - 구성정보
            - DB이름, 데이터 파일명, REDO로그파일명, 테이블 스페이스에 관한 정보 등.
            - DB구성이 변경될 때마다 오라클에 의해 갱신. 구성정보와 실제 파일위치 일치해야함.(위치 다를경우 DB기동X)
        - 운영관리정보
            - REDO로그/아카이브REDO로그에 관한 정보, 백업파일에 관한 정보, 체크포인트 정보 등
        - 컨트롤 파일 하나라도 손상되면 인스턴스 정지.
        - 인스턴스 기동중일때 컨트롤파일에 항상 접근할 수 있어야 함.(접근 불가능해질경우 인스턴스 강제종료)
        - **다중화**
            - 구성정보, 운영관리정보 보호하기 위함.
            - **컨트롤파일에 저장된 정보의 보호**에 중점
        - 컨트롤 파일 확인: *V$CONTROLFILE* 뷰에서 확인가능
    - **데이터 파일**: 테이블, 인덱스, UNDO데이터, 임시데이터, 시스템 관리용 데이터 저장, 저장되는 데이터 크기에 따라 파일 크기 다름.
    - **REDO로그 파일**: 변경 이력 저장. 데이터 변경량 많을 경우 큰 파일 크기 사용
- 인스턴스: `SGA + 백그라운드 프로세스`. 인스터스가 기동하지 않으면 오라클 이용할 수 없음.
    - SGA: 데이터베이서 버퍼 캐시, REDO 로그 버퍼, Shared Pool 등. 프로세스 간 공유 메모리 영역.
    인스턴스 기동 시 초기화 파라미터 설정값에 따라 SGA 공간확보
    - 백그라운드 프로세스: 인스턴스 기동에 맞춰 시작. 프로세스 감시하거나 데이터를 파일에 기록하는 등의 작업을 수행
- 데이터베이스와 인스턴스 관계
    - RAC를 사용하지 않는 경우
        - 인스턴스와 데이터베이스 1:1 대응
        - *인스턴스의 기동 및 데이터베이스 오픈 = 데이터베이스의 기동*
        - 같은 서버내에 여러개의 인스턴스와 데이터베이스 기동할 수 있음 (각각 1:1 대응)
    - RAC(Real Application Clusters)를 사용하는 경우
        - 여러개 인스턴스와 하나의 데이터베이스(N:1 대응)
        - 한개의 인스턴스 정지하더라도 데이터 베이스 멈추지 않음.

### 초기화 파라미터 파일

- 초기화 파라미터: 오라클에 관한 특성 결정. 각종 메모리 영역 크기, 다양한기능 ON/OFF, 프로세스 동작방식등을 변경가능
- 인스턴스가 시작되면 초기화 파라미터 파일이 읽혀짐.
    - 서버 파라미터 파일(SPFILE): 일반적으로 사용되는 초기화 파라미터 파일 유형. Binary파일. 수동편집X, 시작 시 자동 검색. 종료 및 시작과 관계없이 계속유지. `spfile<SID>.ora`
    - 텍스트 초기화 파라미터 파일: 읽을 수는 있지만 쓸수는 없음. 종료 및 시작과 관계없이 초기화 파라미터 설정 유지하려면 텍스트 편집기 사용해 수동으로 설정/변경 해야함. SPFILE찾을 수 없는 경우 시작시 자동 검색. `init<SID>.ora`
- 값 유형
    - Boolean, String, Integer, 파라미터파일, Reserved, Big Integer
    - 파생된 파라미터 값
    - 운영체제에 종속적인 파라미터 값
    - 파라미터 값 설정 - 값 늘리면 시스템 성능 개선될 수 있지만 대부분 파라미터 늘리면 SGA크기도 늘어남 → DB성능 일정수준 향상. 
    but, SGA 너무 커서 메모리에서 스왑 인/아웃 수행되면 성능 저하.
- 유형
    - 기본: DB를 최적의 성능으로 계속 실행하기 위해 설정하는 파라미터. 약30개
        - DB_NAME, DB_DOMAIN, DB_RECOVERY_FILE_DEST, DB_RECOVERY_FILE_DEST_SIZE, SGA_TARGET, UNDO_TABLESPACE 등
    - 고급: 기본 파라미터 이외의 모든 파라미터
    - 대표적인 초기화 파라미터
        - CONTROL_FILES: 하나 이상의 Control File 이름 지정. 컨트롤 파일을 다중화하고 미러링 할것을 권장함. 1~8개의 파일이름(경로이름포함) 값. 기본값 운영체제마다 다름
        - DB_FILES: 해당 데이터 베이스에서 대해 열 수 있는 최대 데이터베이스 파일 수 지정. 운영체제마다 값 다름. 기본값 200.
        - PROCESSES: 동시에 연결할 수 있는 최대 OS User Process 수 지정. 모든 백그라운드 프로세스 및 User Process를 수용해야함. 값은 6(최대값은 운영체제마다 다름). 기본값은 CPU수에 따라 다르며 동적인 값.
        - DB_BLOCK_SIZE: 모든 테이블스페이스가 사용하는 데이터베이스 표준 블록크기를 바이트 단위로 지정. 데이터베이스 생성시 설정. 변경불가. 2048~32768의 값(운영체제마다 다름). 기본값 8192
        - DB_CACHE_SIZE: 표준 블록 버퍼 캐시 크기 지정. 최소 4MB X CPU수 의 값. 기본값은 SGA_TARGET설정된 경우 0, 아닌경우 MAX(48MB,4MB*CPU_COUNT)
            - SGA_TARGET: 모든 SGA 구성요소의 전체 크기 지정.⇒ DB_CACHE_SIZE, SHARED_POOL_SIZE, LARGE_POOL_SIZE, JAVA_POOL_SIZE, STREAMS_POOL_SIZE 자동지정
            0이 아닌 값으로 설정되면 해당값을 ASMM(자동공유메모리관리)에서 최소레벨로 사용함. 응용프로그램 구성 요소가 제대로 작동하는데 최소한의 메모리가 필요한경우 최소값 설정.
                - ASMM의 영향을 받지 않는(수동으로 크기 지정되는) 구성요소: 로그버퍼, KEEP 및 RECYCLE등의 기타 버퍼 캐시 및 기타 블록크기, 고정 SGA 및 기타 내부할당
                - MMON: ASMM을 지원하며 자동 튜닝된 메모리 풀의 값을 계산하는 프로세스.
                데이터베이스는 필요에 따라 SGA 및 PGA를 늘리거나 줄이며 MEMORY_TARGET값에 맞게 메모리를 튜닝함.
        - PGA_AGGREAGTE_TARGET: 인스턴스에 연결된 모든 서버 프로세스에 사용가능한 PGA 메모리의 크기 지정. 설정을 위해 인스턴스에서 사용하 수 있는 시스템 전체 메모리에서 SGA뺌.  최소값은 10MB, 최대값은 4096GB-1, 기본값은 MAX(10MB, SGA크기의 20%)
        - SHARED_POOL_SIZE: Shared Pool의 크기를 바이트 단위로 지정. 값은 운영체제마다 다름. 기본값은 SGA_TARGET설정된경우 0, 아니면 64비트일땐 128MB, 32비트일땐 48MB
        - UNDO_MANAGEMENT: 사용할 언두 영역 관리 모드 지정.
            - AUTO로 설정 또는 파라미터 생략시 자동언두관리모드: 언두 테이블스페이스로 언두영역 할당. 값은 AUTO 또는 MANUAL.
            - 그렇지않으면 롤백언두관리모드: 롤백 세그먼트로 언두영역 할당.
- 파라미터 확인
    - SELECT name, value FROM V$PARAMETER : 현재 세션의 현재 파라미터 값
    - *SHOW PARAMETER 문자열*: 해당 문자열을 포함하는 파라미터
    - 파라미터 정보가 포함된 기타뷰
        - *V$PARAMETER*: 서버 파라미터 파일 내용에 대한 정보 표시. 인스턴스를 시작할때 서버 파라미터 파일 사용하지 않은경우, 이 뷰의 각 행에 있는 ISSPECIFIED열에 FALSE표시
        - V$PARAMETER2: 현재 세션에 영향을 주는 초기화 파라미터 정보 표시. 각 파라미터 값이 뷰의 행으로 표시.
        - *V$SYSTEM_PARAMETER*: 현재 인스턴스에 영향을 주는 초기화 파라미터 정보 표시.
- 값 변경
    - Static Parameter
        - 인스턴스 또는 전체 데이터베이스에 영향.
        - 텍스트 초기화 파라미터 파일 또는 서버 파라미터 파일의 내용 변경을 통해 수정가능
        - 데이터베이스(인스턴스)를 재시작해야 적용됌.(SCOPE=SPFILE)
        - 현재 인스턴스에 대해서 static parameter 변경 X
    - Dynamic Parameter
        - 데이터베이스가 온라인 상태인 동안 변경가능
        - 유형
            - 세션레벨: 유저 세션에만 영향. 지정된 세션에서 사용할 수 있음. 해당 세션이 끝나면 파라미터 만료
            - 시스템(인스턴스)레벨: 전체 데이터베이스 및 모든 세션에 영향. SCOPE설정에 따라 효력 유지.
                - SCOPE=SPFILE: 변경사항 서버 파라미터파일에만 적용. 현재 인스턴스는 변경X. 변경사항들은 다음 시작시 부터 영구적용
                - SCOPE=MEMORY: 변경사항 메모리에만 적용. 텍스트 초기화 파라미터 파일을 사용해 인스턴스 시작한 경우 기본값. 현재 인스턴스 변경. 변경사항들은 즉시 적용. 영구적용X(재기동시 설정 초기화)
                - SCOPE=BOTH: 변경사항이 서버파라미터 파일과 메모리 모두 적용. 서버 파라미터 파일을 이용해 인스턴스 시작한 경우 기본값. 현재 인스턴스 변경. 영구적용(재기동후에도 설정값 유효)
        - ALTER SESSION 및 ALTER SYSTEM명령을 사용하여 변경 가능

## Instance 기동과 정지

### 기동

`SHUTDOWN` - startup - `NOMOUNT` - (alter database mount) - `MOUNT` - (alter database open) - `OPEN`

SYS계정으로 SYSDAB권한을 지정/접속 후 startup명령 수행

- **SHUTDOWN(CLOSE)**
    - 정지상태
    - 환경변수 ‘ORACLE_HOME’과 ‘ORACLE_SID’를 바탕으로 초기화 파라미터 파일 찾아 읽음.
    - 파라미터를 읽어 SGA 할당 및 백그라운드 프로세스 생성
- **NOMOUNT**
    - 인스턴스가 기동한 상태
    - 백그라운드 프로세스와 공유메모리가 존재하는 상태
    - Control file을 읽어 데이터베이스를 구성하는 각종 파일의 위치확인(데이터 파일, 리두로그파일 등 정보 파악)
- **MOUNT**
    - 데이터 파일등에 접근할 수 있는 상태(컨트롤 파일을 읽은 상태)
    - 데이터파일을 열어 간단한 점검. 백그라운드 프로세스 기동
- **OPEN**
    - 데이터 처리를 할 수 있는 상태, SQL을 처리할 수 있는 상태.
- ALERT Log(alert_<sid>.log)에 각 상태의 전환이 수시로 출력되므로 기동처리 흐름 확인가능
- 파일 사용순서
    - *초기화 파라미터 파일 → 컨트롤 파일 → 데이터파일*
    - 사용순서 테스트
        - 초기화 파라미터 파일 올바른 위치에 있지않다면
            - 에러발생. 기동X. NOMOUNT 되지않음
        - 컨트롤 파일 없다면
            - 에러발생. 기동X. MOUNT 실패
        - 데이터 파일 삭제했다면
            - 에러발생. 기동X. OPEN 실패
        - 오래된 데이터 파일로 바꾸었다면
            - 에러발생. 기동X. OPEN 실패. 복구가 필요하다고 알려줌

### 정지

`OPEN` - shutdown - `MOUNT` - `NOMOUNT` - `SHUTDOWN`

SYS계정으로 SYSDAB권한을 지정/접속 후 shutdown 명령 수행

- 데이터베이스를 닫은 후 인스턴스 종료
- 인스턴스 정지: 공유메모리 반환. 백그라운드 프로세스 정지
- 버퍼캐시에 분산된 데이터 정리
- shutdown의 옵션
    - normal: 기본값. 접속의 종료를 기다림. 일관성 확보. 변경된 데이터를 데이터 파일에 기록
    - transactional: 트랜잭션 끝나는 것을 기다림. 트랜잭션 끝나면 접속 끊음. 일관성 확보. 변경된 데이터를 데이터 파일에 기록
    - immediate: 접속의 종료를 기다리지않음. 커밋하지 않은 데이터 없어짐. 롤백이 수행됌. 일관성 확보. 변경된 데이터를 데이터 파일에 기록
    - abort: 접속의 종료를 기다리지않음. 커밋하지 않은 데이터 없어짐. 롤백되지않음. 일관성 확보X(운영환경에서 사용X), 변경된 데이터를 기록하지 않음.

### 인스턴스 복구(instance recovery)

- 인스턴스 장애 발생 후 기동할때 SMON에 의해 자동실행
- 정식 명칭은 장애복구(crash recovery)
- shutdown의 abort사용 - 다음 기동시 리두로그 파일 데이터 사용하여 복구
- OS장애나 서버장비 장애 등 오라클 비정상 종료시
- 데이터 파일이 존재하지 않는 등 파일에 관한 장애 발생시 본격적인 복구 작업해야함.(⇒미디어복구)
    - 미디어복구: 미리 받아 둔 백업파일에서 데이터베이스를 복구하는 방법
        - 백업된 데이터 파일 복원.
        - 데이터파일에 아카이브 REDO 로그파일이나 REDO 로그파일의 REDO 데이터를 적용해 데이터 파일을 장애 발생 시점까지 변경
- 인스턴스와 미디어 복구 비교

|  | 인스턴스 복구 | 미디어복구 |
| --- | --- | --- |
| 대처가능 장애 | 인스턴스, OS의 비정상 종료 또는 강제 정지 | 데이터베이스를 구성하는 파일의 손실 |
| 사용하는 REDO로그파일 | 온라인REDO로그파일 | 온라인REDO로그파일, 아카이브REDO로그파일 |
| 복구수행방법 | 비정상종료/강제정지 후 인스턴스 기동 시 자동실행 | DBA가 명령어입력(RECOVER)를 통해 수행 |
| 백업 | 불필요 | 필요 |
| 복원 | 불필요 | 필요 |
| 아카이브 로그 모드운영 | 불필요 | 필요 |

